plugins {
    id 'java'
    id 'war'
    id 'org.springframework.boot' version '2.7.18'
    id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com'
version = '0.0.1-SNAPSHOT'
description = 'core'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(8)
    }
}

repositories {
    println "ğŸŒ Repository: Maven Central"
    mavenCentral()
    // --offline í”Œë˜ê·¸ ì‚¬ìš© ì‹œ ìë™ìœ¼ë¡œ ~/.gradle/caches ì‚¬ìš©
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'

    // Validation
    implementation 'org.springframework.boot:spring-boot-starter-validation'

    // lombok
    compileOnly("org.projectlombok:lombok:1.18.42")
    annotationProcessor("org.projectlombok:lombok:1.18.42")

    // JSP support
    implementation 'org.apache.tomcat.embed:tomcat-embed-jasper'
    implementation 'javax.servlet:jstl:1.2'

    // MyBatis
    implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.3.2'

    providedRuntime 'org.springframework.boot:spring-boot-starter-tomcat'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

// ==================== ì˜¤í”„ë¼ì¸ í™˜ê²½ ì¤€ë¹„ ====================

// 1. ëª¨ë“  ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ë° ë³µì‚¬
tasks.register('downloadDependencies') {
    description = 'ëª¨ë“  ì˜ì¡´ì„±ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤ (í”ŒëŸ¬ê·¸ì¸ í¬í•¨)'
    group = 'offline'

    doLast {
        // ëª¨ë“  configurationì˜ ì˜ì¡´ì„± í•´ê²°
        configurations.each { configuration ->
            if (configuration.canBeResolved) {
                try {
                    configuration.resolve()
                } catch (Exception e) {
                    logger.warn("Could not resolve configuration: ${configuration.name}")
                }
            }
        }
        println "âœ“ ëª¨ë“  ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
    }
}

// 2. ì˜ì¡´ì„±ì„ libs ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
tasks.register('copyDependencies', Copy) {
    description = 'ì˜ì¡´ì„±ì„ libs ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤'
    group = 'offline'

    from configurations.runtimeClasspath
    from configurations.compileClasspath
    into 'libs/dependencies'
}

// 3. Gradle Wrapper ë°°í¬ë³¸ì„ ë¡œì»¬ì— ë³µì‚¬
tasks.register('copyGradleWrapper', Copy) {
    description = 'Gradle Wrapper ë°°í¬ë³¸ì„ ë¡œì»¬ì— ë³µì‚¬í•©ë‹ˆë‹¤'
    group = 'offline'

    def gradleVersion = gradle.gradleVersion
    def gradleZip = "gradle-${gradleVersion}-all.zip"
    def gradleUrl = "https://services.gradle.org/distributions/${gradleZip}"
    def destDir = file('gradle-offline')

    doFirst {
        destDir.mkdirs()

        // Gradle ë°°í¬ë³¸ ë‹¤ìš´ë¡œë“œ
        def gradleDistFile = new File(destDir, gradleZip)
        if (!gradleDistFile.exists()) {
            println "Gradle ${gradleVersion} ë°°í¬ë³¸ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            ant.get(src: gradleUrl, dest: gradleDistFile)
            println "âœ“ Gradle ë°°í¬ë³¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${gradleDistFile}"
        } else {
            println "âœ“ Gradle ë°°í¬ë³¸ ì´ë¯¸ ì¡´ì¬: ${gradleDistFile}"
        }
    }
}

// 4. ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ìƒì„±
tasks.register('createOfflinePackage') {
    description = 'ì˜¤í”„ë¼ì¸ ì‹¤í–‰ì„ ìœ„í•œ ì „ì²´ íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤'
    group = 'offline'

    dependsOn downloadDependencies, copyDependencies, copyGradleWrapper

    doLast {
        def offlineDir = file('offline-package')
        offlineDir.mkdirs()

        def currentGradleVersion = gradle.gradleVersion

        // README íŒŒì¼ ìƒì„±
        def readme = new File(offlineDir, 'OFFLINE_SETUP.md')
        readme.text = """
# ì˜¤í”„ë¼ì¸ í™˜ê²½ ì„¤ì • ê°€ì´ë“œ

## 1. ì¤€ë¹„ëœ íŒŒì¼ë“¤

- `gradle-offline/` - Gradle ë°°í¬ë³¸ (${currentGradleVersion})
- `libs/dependencies/` - í”„ë¡œì íŠ¸ ì˜ì¡´ì„± JAR íŒŒì¼ë“¤
- `.gradle/` - Gradle ìºì‹œ (ìë™ ìƒì„±ë¨)

## 2. ì˜¤í”„ë¼ì¸ í™˜ê²½ ì„¤ì • ë°©ë²•

### ë°©ë²• 1: --offline í”Œë˜ê·¸ ì‚¬ìš© (ê°€ì¥ ê°„ë‹¨)

1. ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ ì˜¤í”„ë¼ì¸ í™˜ê²½ìœ¼ë¡œ ë³µì‚¬
2. Gradle ìºì‹œë„ í•¨ê»˜ ë³µì‚¬:
   - ~/.gradle/ ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ ë³µì‚¬

3. ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ë¹Œë“œ:
   ```bash
   ./gradlew build --offline
   ```

### ë°©ë²• 2: Gradle Wrapper ë¡œì»¬ ë°°í¬ë³¸ ì‚¬ìš©

1. gradle-wrapper.properties ìˆ˜ì •:
   ```properties
   distributionBase=GRADLE_USER_HOME
   distributionPath=wrapper/dists
   distributionUrl=file:///\${í”„ë¡œì íŠ¸ê²½ë¡œ}/gradle-offline/gradle-${currentGradleVersion}-all.zip
   zipStoreBase=GRADLE_USER_HOME
   zipStorePath=wrapper/dists
   ```

2. ë¹Œë“œ:
   ```bash
   ./gradlew build --offline
   ```

### ë°©ë²• 3: ëª¨ë“  ìºì‹œ í¬í•¨ ë³µì‚¬

ì˜¨ë¼ì¸ í™˜ê²½ì—ì„œ:
```bash
# 1. ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
./gradlew build --refresh-dependencies

# 2. ë‹¤ìŒ ë””ë ‰í† ë¦¬ë“¤ì„ ë°±ì—…
tar -czf gradle-cache.tar.gz ~/.gradle/caches ~/.gradle/wrapper
```

ì˜¤í”„ë¼ì¸ í™˜ê²½ì—ì„œ:
```bash
# 1. ìºì‹œ ë³µì›
tar -xzf gradle-cache.tar.gz -C ~/

# 2. ë¹Œë“œ
./gradlew build --offline
```

## 3. ì¶”ì²œ ë°©ë²•

**ê°€ì¥ ê°„ë‹¨í•œ ì˜¤í”„ë¼ì¸ ì¤€ë¹„:**

```bash
# ì˜¨ë¼ì¸ í™˜ê²½
./gradlew createOfflinePackage
./gradlew build --refresh-dependencies
cd ~
tar -czf gradle-home.tar.gz .gradle/

# ì˜¤í”„ë¼ì¸ í™˜ê²½ìœ¼ë¡œ ë³µì‚¬:
# 1. í”„ë¡œì íŠ¸ ì „ì²´ ë””ë ‰í† ë¦¬
# 2. gradle-home.tar.gz

# ì˜¤í”„ë¼ì¸ í™˜ê²½
tar -xzf gradle-home.tar.gz -C ~/
cd í”„ë¡œì íŠ¸ê²½ë¡œ
./gradlew build --offline
```

## 4. ì£¼ì˜ì‚¬í•­

- `--offline` í”Œë˜ê·¸ëŠ” ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ì„ ì™„ì „íˆ ì°¨ë‹¨í•©ë‹ˆë‹¤
- ì²˜ìŒ ì‹¤í–‰ ì‹œ Gradleì´ ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ë¯€ë¡œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ìƒˆë¡œìš´ ì˜ì¡´ì„± ì¶”ê°€ ì‹œ ì˜¨ë¼ì¸ í™˜ê²½ì—ì„œ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ í•„ìš”
- verification-metadata.xmlì´ ìˆëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ìœ ì§€

## 5. ê²€ì¦

ì˜¤í”„ë¼ì¸ ëª¨ë“œ í…ŒìŠ¤íŠ¸:
```bash
./gradlew clean build --offline
```

ì„±ê³µí•˜ë©´ ì˜¤í”„ë¼ì¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!

## 6. ë¬¸ì œ í•´ê²°

### "Could not resolve" ì—ëŸ¬ ë°œìƒ ì‹œ:
1. ~/.gradle/caches ë””ë ‰í† ë¦¬ í™•ì¸
2. ì˜¨ë¼ì¸ í™˜ê²½ì—ì„œ `./gradlew build --refresh-dependencies` ì¬ì‹¤í–‰
3. ~/.gradle ì „ì²´ë¥¼ ë‹¤ì‹œ ë³µì‚¬

### Gradle Wrapper ë‹¤ìš´ë¡œë“œ ì—ëŸ¬:
1. gradle-offline/ ë””ë ‰í† ë¦¬ í™•ì¸
2. gradle-wrapper.propertiesì˜ distributionUrlì„ ë¡œì»¬ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½
"""

        // ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        def setupScript = new File(offlineDir, 'setup-offline.sh')
        setupScript.text = """#!/bin/bash
# ì˜¤í”„ë¼ì¸ í™˜ê²½ ìë™ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸

echo "=== Gradle ì˜¤í”„ë¼ì¸ í™˜ê²½ ì„¤ì • ==="

# 1. Gradle í™ˆ ë””ë ‰í† ë¦¬ ë°±ì—…
echo "1. Gradle ìºì‹œ ë°±ì—… ì¤‘..."
if [ -d "\$HOME/.gradle" ]; then
    tar -czf gradle-home-backup.tar.gz -C \$HOME .gradle
    echo "   âœ“ ë°±ì—… ì™„ë£Œ: gradle-home-backup.tar.gz"
else
    echo "   ! .gradle ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € './gradlew build'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
fi

# 2. í”„ë¡œì íŠ¸ íŒŒì¼ ì••ì¶•
echo "2. í”„ë¡œì íŠ¸ ì••ì¶• ì¤‘..."
tar -czf project-offline.tar.gz \\
    --exclude='build' \\
    --exclude='.gradle' \\
    --exclude='.idea' \\
    --exclude='*.iml' \\
    --exclude='out' \\
    .

echo "   âœ“ ì••ì¶• ì™„ë£Œ: project-offline.tar.gz"

echo ""
echo "=== ì˜¤í”„ë¼ì¸ í™˜ê²½ìœ¼ë¡œ ë³µì‚¬í•  íŒŒì¼ ==="
echo "  1. project-offline.tar.gz (í”„ë¡œì íŠ¸)"
echo "  2. gradle-home-backup.tar.gz (Gradle ìºì‹œ)"
echo ""
echo "=== ì˜¤í”„ë¼ì¸ í™˜ê²½ì—ì„œ ì‹¤í–‰ ==="
echo "  tar -xzf gradle-home-backup.tar.gz -C \$HOME"
echo "  tar -xzf project-offline.tar.gz"
echo "  ./gradlew build --offline"
"""
        setupScript.setExecutable(true)

        println """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ!                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ìƒì„±ëœ íŒŒì¼:
  - gradle-offline/             : Gradle ${currentGradleVersion} ë°°í¬ë³¸
  - libs/dependencies/          : í”„ë¡œì íŠ¸ ì˜ì¡´ì„± (${configurations.runtimeClasspath.files.size()} íŒŒì¼)
  - offline-package/            : ì„¤ì • ê°€ì´ë“œ ë° ìŠ¤í¬ë¦½íŠ¸
    - OFFLINE_SETUP.md          : ìƒì„¸ ì„¤ëª…ì„œ
    - setup-offline.sh          : ìë™ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸

ë‹¤ìŒ ë‹¨ê³„:
  1. 'offline-package/setup-offline.sh' ì‹¤í–‰ (ìë™)
     ë˜ëŠ”
  2. OFFLINE_SETUP.md íŒŒì¼ì˜ ì§€ì¹¨ì„ ë”°ë¼ ìˆ˜ë™ ì„¤ì •
  3. ìƒì„±ëœ íŒŒì¼ë“¤ì„ ì˜¤í”„ë¼ì¸ í™˜ê²½ìœ¼ë¡œ ë³µì‚¬
  4. './gradlew build --offline' ì‹¤í–‰

ë¹ ë¥¸ ì‹œì‘:
  ./offline-package/setup-offline.sh

"""
    }
}

// 5. Gradle ìºì‹œë¥¼ í¬í•¨í•œ ì „ì²´ ë°±ì—…
tasks.register('packageForOffline', Zip) {
    description = 'ì˜¤í”„ë¼ì¸ ë°°í¬ìš© ZIP íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤'
    group = 'offline'

    dependsOn createOfflinePackage, build

    archiveFileName = "offline-package-${project.version}.zip"
    destinationDirectory = file('build')

    from(projectDir) {
        exclude 'build/**'
        exclude '.gradle/**'
        exclude '.idea/**'
        exclude '*.iml'
        exclude 'out/**'
    }

    from('gradle-offline') {
        into 'gradle-offline'
    }

    from('libs/dependencies') {
        into 'libs/dependencies'
    }

    doLast {
        println """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ì˜¤í”„ë¼ì¸ ë°°í¬ ZIP ìƒì„± ì™„ë£Œ!                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ìƒì„±ëœ íŒŒì¼: build/${archiveFileName.get()}

ì´ ZIP íŒŒì¼ì—ëŠ” ë‹¤ìŒì´ í¬í•¨ë©ë‹ˆë‹¤:
  - ì†ŒìŠ¤ ì½”ë“œ
  - Gradle Wrapper
  - Gradle ë°°í¬ë³¸
  - ëª¨ë“  ì˜ì¡´ì„±

ì˜¤í”„ë¼ì¸ í™˜ê²½ì—ì„œ:
  1. ZIP ì••ì¶• í•´ì œ
  2. ./gradlew build --offline ì‹¤í–‰
"""
    }
}

